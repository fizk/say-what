<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/app-route/app-route.html">
<link rel="import" href="../../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../../pages/articles-article/articles-article.html">
<link rel="import" href="../../pages/articles-list/articles-list.html">
<link rel="import" href="../../pages/articles-edit/articles-edit.html">

<dom-module id="articles-container">
    <template>
        <iron-ajax
                auto
                url="/data/data.json"
                handle-as="json"
                on-response="_handleResponse"
                debounce-duration="300"></iron-ajax>

        <app-route
                route="{{route}}"
                path="/">
        </app-route>
        <app-route
                route="{{route}}"
                path="/:slug"
                data="{{slugData}}">
        </app-route>
        <app-route
                route="{{route}}"
                path="/:slug/edit"
                data="{{slugData}}">
        </app-route>

        <iron-pages selected="[[key]]" attr-for-selected="key">
            <articles-list key="" articles="[[articles]]" user="[[user]]"></articles-list>
            <articles-article key="selected" articles="[[articles]]" slug="[[slug]]" user="[[user]]"></articles-article>
            <articles-edit key="edit" slug="[[slug]]" articles="[[articles]]"></articles-edit>
        </iron-pages>

    </template>
    <script>
        Polymer({
            is: 'articles-container',

            observers: [
                '_observerRoutePath(route.path)'
            ],

            properties: {
                articles: {
                    type: Array,
                    value: []
                },
                key: {
                    type: String,
                    value: ''
                },
                slug: {
                    type: String
                }
            },

            /**
             *
             * @param path
             * @private
             * @todo this is terrible...
             */
            _observerRoutePath: function (path) {
                if (!path) {
                    this.slug = undefined;
                    this.key = '';
                } else if (path.match(/^\/[0-9a-zA-Z\-]+$/)) {
                    this.key = 'selected';
                    this.slug = path.substring(1);
                } else if (path.match(/^\/[0-9a-zA-Z\-]+\/edit$/)) { //TODO ... && this.user
                    this.key = 'edit';
                    this.slug = path.match(/(\/)([0-9a-zA-Z\-]+)(\/edit)$/)[2];
                } else {
                    this.slug = undefined;
                    this.key = '';
                }
            },

            _handleResponse: function (response) {
                this.articles = response.detail.response.articles.sort(function (a, b) {
                    return new Date(b.date) - new Date(a.date);
                });
            }

        })
    </script>
</dom-module>
