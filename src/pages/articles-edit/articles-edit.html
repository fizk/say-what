<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../../bower_components/paper-toggle-button/paper-toggle-button.html">

<link rel="import" href="../../behaviors/article-behaviors.html">

<dom-module id="articles-edit">
    <template>
        <h1><a href="[[_articleURL(article.$key)]]">[[article.content.title]]</a></h1>
        <form id="form" is="iron-form" on-submit="_updateArticle">
            <template is="dom-repeat" items="[[article.authors]]">
                <paper-input value="[[item]]" label="Author" name="authors"></paper-input>
            </template>
            <paper-input value="[[article.content.title]]" label="Title" name="title"></paper-input>
            <paper-textarea value="[[article.content.text]]" label="Body" name="text"></paper-textarea>
            <label>
                From data
                <input type="date" name="from" value="[[article.date.from]]">
            </label>
            <label>
                To data
                <input type="date" name="to" value="[[article.date.to]]">
            </label>
            <paper-toggle-button label="Pinned" checked="[[article.pinned]]" name="pinned">Pinned</paper-toggle-button>
            <button>Send</button>
        </form>
    </template>
    <script>
        Polymer({
            is: 'articles-edit',

            observers: [
                '_observerArticles(articles, slug)'
            ],

            behaviors: [
                ArticleBehaviors.UrlHelpers
            ],

            properties: {
                articles: {
                    type: Array,
                    value: []
                },

                article: {
                    type: Object
                },

                slug: {
                    type: String
                }
            },

            _updateArticle: function (event) {
                if (this.article) {
                    event.preventDefault();
                    var formData = event.currentTarget.serialize();
                    var data = Object.assign({}, this.article, {
                        content: {
                            title: formData.title,
                            text: formData.text
                        },
                        pinned: formData.pinned ? true : false,
                        authors: (Array.isArray(formData.authors)) ? formData.authors : [formData.authors]
                    });
                    delete data.$key;

                    this.fire('article-update', {data: data, slug: this.slug});
                }
            },

            _observerArticles: function (articles, slug) {
                this.article = articles.filter(function (article) {
                    return article.$key == slug;
                }).pop();
            }
        })
    </script>
</dom-module>
